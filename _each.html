<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="user-scalable=no, initial-scale=1, width=device-width">
	<link rel="stylesheet" type="text/css" href="">
	<style type="text/css">

body > div 
	{
		border-bottom: 1px solid #ccc;
	}

p,
a 
	{
		padding-bottom: 0;
		margin-top: 0;
		margin-bottom: 0.25em;
	}
a,
a:link,
a:visited 
	{
		display: block;
		color: black;
	}
	</style>
</head>
<body>

<div>
	<p id="blargh">p#blargh</p>
	<p class="ugh">p.ugh</p>
	<p class="foo">p.foo</p>
	<p>p</p>
	<p>p</p>
	<p class="ugh">p.ugh</p>
</div>
<div>
	<p>p:first-child</a>
	<a href="blah">a:first-of-type:link</a>
	<a>a</a>
	<a href="blah">a:link</a>
	<a href="blah" class="bar">a:link.bar</a>
	<a href="blah" class="foo">a:link.foo</a>
	<a>a</a>
	<a>a</a>
	<a href="blah">a:link:last-child</a>
</div>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script> 
	<script type="text/javascript">
// var app = {};
// app.times = {};
// app.times.start = Date.now();
// app.times.end = 0;
// var oO = {};

var oO = function(str,fn) {
	return oO.every(oO.select(str),fn,str);
}

oO.select = function(str) {

	str = str.replace(/ /g,'');
	console.log(str);
	var m = str;
	var re = /,(?![^\(]*\))/g; 
	var regMatch = re.exec(m);

	var comment = '';

	// verify str is not a comma separated list of selectors
	// if (str.indexOf(',') < 0) { 
	// 	return result(str);
	// } else if (regMatch == null) { 
	
	if (str.indexOf(',') > -1 && regMatch != null) { 

		console.log(regMatch);

		comment = 'str contains commas but does not contain commas within parentheses';
		console.log(comment);

		// iterate through a comma separated list of selectors & return each array item recursively to the function 
		var arr = str.split(',');
		for (var i = 0; i < arr.length; i++) {
			arr[i] = oO.select(arr[i]);
		}
		return arr;

	} else if (regMatch != null) { 

		function regThis() {
			if (regMatch != null) {
				var item = m.substr(0,regMatch.index);
				arr[iii] = item;
				iii++;
				m = m.substr(regMatch.index+1);
				regMatch = re.exec(m);
				if (regMatch != null) {
					regThis();
				} else {
					arr[iii] = m;
					console.log(arr);
					for (var i = 0; i < arr.length; i++) {
						console.log(arr[i]);
						if (typeof oO.select(arr[i]) != 'undefined') {
							// arr[i] = oO.select(arr[i]);
							arr[i] = result(arr[i]);
						} else {
							arr[i] = null;
						}
						console.log(arr);
					}
					// return arr;
				}
			}
		}

		if (regMatch != null) {
			console.log('regMatch != null');
			var arr = [];
			var iii = 0;
			regThis();
			return arr;
		} else {	
			// iterate through a comma separated list of selectors & return each array item recursively to the function 
			// str = str.replace(/ /g,'');
			var arr = str.split(',');
			for (var i = 0; i < arr.length; i++) {
				arr[i] = oO.select(arr[i]);
			}
			return arr;
		} 
	// } else if (str.indexOf(',') > -1 && regMatch == null) { 
	} else if (str.indexOf(',') > -1 && str.indexOf('|')) { 
		comment = 'str contains commas & a method';
		console.log(comment);
		var arr = [];
		var elem = str.substr(0,str.indexOf('|'));
		var filterSelectors = str.substr(str.indexOf('(') + 1, str.indexOf(')') - str.indexOf('(') - 1).split(',');
		var method = str.substr(str.indexOf('|') + 1,str.indexOf('(') - str.indexOf('|') - 1);
		// console.log(elem);
		for (var iiii = 0; iiii < filterSelectors.length; iiii++) {
			arr[iiii] = elem + '|' + method + '(' + filterSelectors[iiii] + ')';
			// arr.push(elem);
			// arr[i] = elem + '|' + method + '(' + filterSelectors[i] + ')';
		}

		// console.log(arr.join());
		// for (var iiiii = 0; iiiii < arr.length; iiiii++) {
		// 	arr[iiiii] = result(arr[iiiii]);
		// 	console.log(arr[iiiii]);
		// }
		// return arr;
		// return arr;
		return result(str);
	} else if (str.indexOf(',') < 0) { 
		return result(str);
	} else {
		comment = 'out of pattern';
		console.log(comment);
	}
	function result(str) {
		if (str.indexOf('|') > -1) {
			// if (str.indexOf('')))
			var method = str.substr(str.indexOf('|') + 1,str.indexOf('(') - str.indexOf('|') - 1);
			// console.log(method);
			switch(method) {
				case 'eq':
					var index = parseInt(str.substr(str.indexOf('(') + 1, str.indexOf(')') - str.indexOf('(') - 1));
					str = str.substr(0,str.indexOf('|'));
					return document.querySelectorAll(str)[index];
				break;
				case 'gt':
					var index = parseInt(str.substr(str.indexOf('(') + 1, str.indexOf(')') - str.indexOf('(') - 1));
					str = str.substr(0,str.indexOf('|'));
					return new Array().push(document.querySelectorAll(str)[index]);
				break;
				case 'not':
					var filter = str.substr(str.indexOf('(') + 1, str.indexOf(')') - str.indexOf('(') - 1);
					// console.log(filter);
					str = str.substr(0,str.indexOf('|'));
					var objs = document.querySelectorAll(str);

					if (filter.indexOf(',') > -1) {
						console.log('multiple filter selectors');
					} else {
						console.log('single filter');
					}
					// change filter functionality to be array based instead of a string 

					// presuming single filter 
					var filterType = filter.substr(0,1);
					if (filterType == '.' || filterType == '#') {
						filter = filter.substr(1);
					}
					var arr = [];
					for (var i = 0; i < objs.length; i++) {
						switch(filterType) {
							case '.':
								if (objs[i].className.indexOf(filter) > -1) {
									objs[i] = '';
								} else {
									arr.push(objs[i]);
								}
							break;
							case '#':
								if (objs[i].id.indexOf(filter) > -1) {
									objs[i] = '';
								} else {
									arr.push(objs[i]);
								}
							break;
							default:
							break;
						}
					}
					return arr;
				break;

			}
		} else {
			if (document.querySelectorAll(str).length > 0) {
				return document.querySelectorAll(str);
			} else {
				return undefined;
			};
		};
		// if (str.substr(0,1) === '#') {
		// 	return new Array(document.getElementById(str.substr(1)));
		// } else if (str.substr(0,1) === '.') {
		// 	return document.getElementsByClassName(str.substr(1));
		// } else if (str.indexOf(':') > - 1 || str.indexOf('>') > -1) {
		// 	return document.querySelectorAll(str);
		// } else {
		// 	return document.getElementsByTagName(str);
		// }
	};
	// NO ERROR HANDLING IF NO MATCHING ELEMENTS FOUND
};

oO.every = function(obj, fn, str) {

	console.log(obj);
	console.time('each: ' + str);

	if (typeof obj != 'undefined') {
		if (obj.length && typeof obj[0] != null && typeof obj != 'undefined') {
			for (var i = 0, ol = obj.length, v = obj[i]; i < ol; i++) {
				if (typeof obj[i] != 'undefined' && obj[i] != null) {

					if (obj[i].length) {
						// iterate through an array of selectors
						oO.every(obj[i],fn,str);
					} else {
						// execute the callback function for single selector
						fn(obj[i], i);
					} 

				}
			};	
		} else if (obj.length === 0 && typeof obj[0] != null && typeof obj != 'undefined') {
			fn(obj,0);
		// } else if (typeof obj[0] != null) {
		// 	console.log(obj);
			// for (var p in obj) {
			// 	// console.log(p);
			// 	if (fn(obj[p], p) === false) {
			// 		console.log(p);
			// 		break;
			// 	}
			// }
		} else {
			fn(obj,0);
		}
	} else {
		// console.log('array empty');
	}
	console.timeEnd('each: ' + str);

	// if (obj.length) for (var i = 0, ol = obj.length, v = obj[0]; i < ol && fn(v, i) !== false; v = obj[++i]);
	// else for (var p in obj) if (fn(obj[p], p) === false) break;

	// 2DO ERROR HANDLING FOR NO MATCHING ELEMENTS FOUND
};


function doStuff(obj, index) {
	if (typeof obj == 'object' && obj.length != 0) {
		obj.style.color = 'orange';
	} else {
		console.log('no obj');
	}
}

function undoStuff(obj, index) {
	obj.style.color = '';	
}


// ---------------------------------------------------------------------

var timing = 200;
var currentTime = timing;

function runDemo(target) {

	setTimeout(function() {
		oO(target,doStuff)
	}, currentTime);
	currentTime += timing;
	setTimeout(function() {
		oO(target,undoStuff);
	}, currentTime);
	currentTime += timing;

}


function playDemo() {

	// runDemo('a:first-of-type');
	// runDemo('a:link:last-child');
	// runDemo('p|eq(4)');
	// runDemo('p:last-child');
	runDemo('a|not(.foo, #bar)');
	// runDemo('p, #boo, #urns, a|not(.foo, #bar), #blargh');
	// runDemo('p|not(#blargh)');
	// runDemo('#blargh');
	// runDemo('p');
	// runDemo('p:nth-of-type(2n)');
	// runDemo('a');
	// runDemo('a:link');
	// runDemo('a:link, p');
	// runDemo('#blargh, .ugh');
	// runDemo('#blargh');
	// runDemo('.ugh');
	// runDemo('#buh');
	// runDemo('h1');
	// runDemo('*');

	// console.time('jquery');
	// $('*').each(function() {
	// 	console.log(this);
	// });
	// console.timeEnd('jquery');
	
}

document.addEventListener('DOMContentLoaded', function() {

	playDemo();

}, false);

	</script>
</body>
</html>