<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="user-scalable=no, initial-scale=1, width=device-width">
	<link rel="stylesheet" type="text/css" href="">
	<style type="text/css">

body > div 
	{
		border-bottom: 1px solid #ccc;
	}

p,
a 
	{
		padding-bottom: 0;
		margin-top: 0;
		margin-bottom: 0.25em;
	}
a,
a:link,
a:visited 
	{
		display: block;
		color: black;
	}
	</style>
</head>
<body>

<div>
	<p id="blargh">p#blargh</p>
	<p class="ugh">p.ugh</p>
	<p class="foo">p.foo</p>
	<p>p</p>
	<p>p</p>
	<p class="ugh">p.ugh</p>
</div>
<div>
	<p>p:first-child</a>
	<a href="blah">a:first-of-type:link</a>
	<a>a</a>
	<a href="blah">a:link</a>
	<a href="blah" class="foo">a:link.foo</a>
	<a href="blah" class="xyz">a:link.xyz</a>
	<a href="blah" class="zyx">a:link.zyx</a>
	<a href="blah" class="inc">a:link.inc</a>
	<a href="blah" class="dba">a:link.dba</a>
	<a href="blah" id="xxx">a:link#xxx</a>
	<a href="blah" id="yyy">a:link#yyy</a>
	<a href="blah" id="bar">a:link#bar</a>
	<a>a</a>
	<a>a</a>
	<a href="blah">a:link:last-child</a>
</div>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script> 
	<script type="text/javascript">
// var app = {};
// app.times = {};
// app.times.start = Date.now();
// app.times.end = 0;
// var oO = {};

var oO = function(str,fn) {
	// this.string = str;
	// this.callback = fn;
	return oO.every(oO.select(str),fn,str);
}

oO.select = function(str) {

	str = str.replace(/ /g,'');
	var m = str;
	var re = /,(?![^\(]*\))/g; 
	var regMatch = re.exec(m);

	var comment = 'comment: ';

	// verify str is not a comma separated list of selectors
	// if (str.indexOf(',') < 0) { 
	// 	return result(str);
	// } else if (regMatch == null) { 
	
	if (str.indexOf(',') > -1 && typeof regMatch != 'object') { 

		// iterate through a comma separated list of selectors & return each array item recursively to the function 
		var arr = str.split(',');
		for (var i = 0; i < arr.length; i++) {
			arr[i] = oO.select(arr[i]);
		}

		return arr;

	} else if (regMatch != null) { 

		function regThis() {
			if (regMatch != null) {
				var item = m.substr(0,regMatch.index);
				arr[iii] = item;
				iii++;
				m = m.substr(regMatch.index+1);
				regMatch = re.exec(m);
				if (regMatch != null) {
					regThis();
				} else {
					arr[iii] = m;
					for (var i = 0; i < arr.length; i++) {
						if (typeof oO.select(arr[i]) != 'undefined') {
							// arr[i] = oO.select(arr[i]);
							arr[i] = result(arr[i]);
						} else {
							arr[i] = null;
						}
					}
					// return arr;
				}
			}
		}

		if (regMatch != null) {
			var arr = [];
			var iii = 0;
			regThis();
			return arr;
		} else {	
			// iterate through a comma separated list of selectors & return each array item recursively to the function 
			// str = str.replace(/ /g,'');
			var arr = str.split(',');
			for (var i = 0; i < arr.length; i++) {
				arr[i] = oO.select(arr[i]);
			}
			return arr;
		} 
	// } else if (str.indexOf(',') > -1 && regMatch == null) { 
	} else if (str.indexOf(',') > -1 && str.indexOf('|') > -1) { 
		var arr = [];
		var elem = str.substr(0,str.indexOf('|'));
		return result(str);
	} else if (str.indexOf(',') < 0) { 
		return result(str);
	} else {
		comment += 'out of pattern';
		console.log(comment);
	}
	function result(str) {
		if (str.indexOf('|') > -1) {
			var method = str.substr(str.indexOf('|') + 1,str.indexOf('(') - str.indexOf('|') - 1);
			switch(method) {
				case 'eq':
					var index = parseInt(str.substr(str.indexOf('(') + 1, str.indexOf(')') - str.indexOf('(') - 1));
					str = str.substr(0,str.indexOf('|'));
					return document.querySelectorAll(str)[index];
				break;
				case 'gt':
					var index = parseInt(str.substr(str.indexOf('(') + 1, str.indexOf(')') - str.indexOf('(') - 1));
					str = str.substr(0,str.indexOf('|'));
					return new Array().push(document.querySelectorAll(str)[index]);
				break;
				case 'not':
					var filterArray = [];
					var filterSelectors = str.substr(str.indexOf('(') + 1, str.indexOf(')') - str.indexOf('(') - 1).split(',');
					var elem = str.substr(0,str.indexOf('|'));
					var objs = document.querySelectorAll(elem);

					var arr = [];
					var zap = [];
					for (var i = 0; i < objs.length; i++) {
						arr.push(objs[i]);
					}
					for (var i = 0; i < arr.length; i++) {
						for (var iiii = 0; iiii < filterSelectors.length; iiii++) {
							var filter = filterSelectors[iiii];
							var filterType = filter.substr(0,1);
							switch(filterType) {
								case '.':
									filterText = filter.substr(1);
									if (objs[i].className.indexOf(filterText) > -1) {
										zap.push(i);
									}
								break;
								case '#':
									filterText = filter.substr(1);
									if (objs[i].id.indexOf(filterText) > -1) {
										zap.push(i);
									}
								break;
								default:
								break;
							}

						} 

					}

					for (var i = 0; i < zap.length; i++) {
						arr.splice(zap[i - i],1);
					}
					return arr;
				break;

			}
		} else {
			if (document.querySelectorAll(str).length > 0) {
				return document.querySelectorAll(str);
			} else {
				return undefined;
			};
		};
		// if (str.substr(0,1) === '#') {
		// 	return new Array(document.getElementById(str.substr(1)));
		// } else if (str.substr(0,1) === '.') {
		// 	return document.getElementsByClassName(str.substr(1));
		// } else if (str.indexOf(':') > - 1 || str.indexOf('>') > -1) {
		// 	return document.querySelectorAll(str);
		// } else {
		// 	return document.getElementsByTagName(str);
		// }
	};
	// NO ERROR HANDLING IF NO MATCHING ELEMENTS FOUND
};

oO.every = function(obj, fn, str) {

	// console.log(obj);
	console.time('each: ' + str);

	if (typeof obj != 'undefined') {
		if (obj.length && typeof obj[0] != null && typeof obj != 'undefined') {
			for (var i = 0, ol = obj.length, v = obj[i]; i < ol; i++) {
				if (typeof obj[i] != 'undefined' && obj[i] != null) {

					if (obj[i].length) {
						// iterate through an array of selectors
						oO.every(obj[i],fn,str);
					} else {
						// execute the callback function for single selector
						fn(obj[i], i);
					} 

				}
			};	
		} else if (obj.length === 0 && typeof obj[0] != null && typeof obj != 'undefined') {
			fn(obj,0);
		// } else if (typeof obj[0] != null) {
		// 	console.log(obj);
			// for (var p in obj) {
			// 	// console.log(p);
			// 	if (fn(obj[p], p) === false) {
			// 		console.log(p);
			// 		break;
			// 	}
			// }
		} else {
			fn(obj,0);
		}
	} else {
		// console.log('array empty');
	}
	console.timeEnd('each: ' + str);

	// if (obj.length) for (var i = 0, ol = obj.length, v = obj[0]; i < ol && fn(v, i) !== false; v = obj[++i]);
	// else for (var p in obj) if (fn(obj[p], p) === false) break;

	// 2DO ERROR HANDLING FOR NO MATCHING ELEMENTS FOUND
};


function doStuff(obj, index) {
	if (typeof obj == 'object' && obj.length != 0) {
		obj.style.color = 'orange';
	} else {
		console.log('no obj');
	}
}
function doOtherStuff(obj, index) {
	if (typeof obj == 'object' && obj.length != 0) {
		obj.style.color = 'blue';
	} else {
		console.log('no obj');
	}
}

function undoStuff(obj, index) {
	obj.style.color = '';	
}


// ---------------------------------------------------------------------

var timing = 200;
var currentTime = timing;

function runDemo(target) {

	setTimeout(function() {
		oO(target,doStuff)
	}, currentTime);
	currentTime += timing;
	setTimeout(function() {
		oO(target,undoStuff);
	}, currentTime);
	currentTime += timing;

}


function playDemo() {
	// oO('a|not(.foo, #bar, .xyz, .zyx, .inc, .dba, #xxx, #yyy)',doStuff);
	// oO('a',doOtherStuff);

	runDemo('a:first-of-type');
	runDemo('a:link:last-child');
	runDemo('p|eq(4)');
	runDemo('p:last-child');
	runDemo('a|not(.foo, #bar, .xyz, .zyx, .inc, .dba, #xxx, #yyy)');
	runDemo('p, a');
	runDemo('p, #boo, #urns, a|not(.foo, #bar), #blargh');
	runDemo('p|not(#blargh)');
	runDemo('#blargh');
	runDemo('p');
	runDemo('p:nth-of-type(2n)');
	runDemo('a');
	runDemo('a:link');
	runDemo('a:link, p');
	runDemo('#blargh, .ugh');
	runDemo('#blargh');
	runDemo('.ugh');
	runDemo('#buh');
	runDemo('h1');
	runDemo('*');

	// console.time('jquery');
	// $('*').each(function() {
	// 	console.log(this);
	// });
	// console.timeEnd('jquery');
	
}

document.addEventListener('DOMContentLoaded', function() {

	playDemo();

}, false);

	</script>
</body>
</html>